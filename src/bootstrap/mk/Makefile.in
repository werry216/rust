ifdef VERBOSE
Q :=
BOOTSTRAP_ARGS := -v
else
Q := @
BOOTSTRAP_ARGS :=
endif

ifdef EXCLUDE_CARGO
AUX_ARGS :=
else
AUX_ARGS := src/tools/cargo src/tools/cargotest
endif

BOOTSTRAP := $(CFG_PYTHON) $(CFG_SRC_DIR)src/bootstrap/bootstrap.py

build:
	$(Q)$(BOOTSTRAP) build $(BOOTSTRAP_ARGS)

all: build doc

help:
	$(Q)echo 'Welcome to the rustbuild build system!'
	$(Q)echo
	$(Q)echo This makefile is a thin veneer over the ./x.py script located
	$(Q)echo in this directory. To get the full power of the build system
	$(Q)echo you can run x.py directly.
	$(Q)echo
	$(Q)echo To learn more run \`./x.py --help\`

clean:
	$(Q)$(BOOTSTRAP) clean $(BOOTSTRAP_ARGS)

rustc-stage1:
	$(Q)$(BOOTSTRAP) build --stage 1 src/libtest $(BOOTSTRAP_ARGS)
rustc-stage2:
	$(Q)$(BOOTSTRAP) build --stage 2 src/libtest $(BOOTSTRAP_ARGS)

docs: doc
doc:
	$(Q)$(BOOTSTRAP) doc $(BOOTSTRAP_ARGS)
nomicon:
	$(Q)$(BOOTSTRAP) doc src/doc/nomicon $(BOOTSTRAP_ARGS)
book:
	$(Q)$(BOOTSTRAP) doc src/doc/book $(BOOTSTRAP_ARGS)
standalone-docs:
	$(Q)$(BOOTSTRAP) doc src/doc $(BOOTSTRAP_ARGS)
check:
	$(Q)$(BOOTSTRAP) test $(BOOTSTRAP_ARGS)
check-aux:
	$(Q)$(BOOTSTRAP) test \
		src/test/run-pass/pretty \
		src/test/run-fail/pretty \
		src/test/run-pass-valgrind/pretty \
		src/test/run-pass-fulldeps/pretty \
		$(AUX_ARGS) \
		$(BOOTSTRAP_ARGS)
check-bootstrap:
	$(Q)$(CFG_PYTHON) $(CFG_SRC_DIR)src/bootstrap/bootstrap_test.py
dist:
	$(Q)$(BOOTSTRAP) dist $(BOOTSTRAP_ARGS)
distcheck:
	$(Q)$(BOOTSTRAP) dist $(BOOTSTRAP_ARGS)
	$(Q)$(BOOTSTRAP) test distcheck $(BOOTSTRAP_ARGS)
install:
	$(Q)$(BOOTSTRAP) install $(BOOTSTRAP_ARGS)
tidy:
	$(Q)$(BOOTSTRAP) test src/tools/tidy $(BOOTSTRAP_ARGS)
prepare:
	$(Q)$(BOOTSTRAP) build nonexistent/path/to/trigger/cargo/metadata

check-stage2-T-arm-linux-androideabi-H-x86_64-unknown-linux-gnu:
	$(Q)$(BOOTSTRAP) test --target arm-linux-androideabi
check-stage2-T-x86_64-unknown-linux-musl-H-x86_64-unknown-linux-gnu:
	$(Q)$(BOOTSTRAP) test --target x86_64-unknown-linux-musl

TESTS_IN_2 := \
	src/test/ui \
	src/test/run-pass \
	src/test/compile-fail \
	src/test/run-pass-fulldeps \
	src/tools/linkchecker

MIN_TEST := \
	src/test/debuginfo

ci-subset-1:
	$(Q)$(BOOTSTRAP) test $(TESTS_IN_2:%=--exclude %)
ci-subset-2:
	$(Q)$(BOOTSTRAP) test $(TESTS_IN_2)

ci-test-prepare: 
	$(Q)$(BOOTSTRAP) test $(MIN_TEST)

ci-resume-subset-1:
	$(Q)$(BOOTSTRAP) test $(TESTS_IN_2:%=--exclude %)
ci-resume-subset-2:
	$(Q)$(BOOTSTRAP) test $(TESTS_IN_2)

TESTS_IN_B := \
	src/tools/linkchecker

TESTS_IN_C := \
	src/test/run-pass \
	src/test/run-pass-fulldeps

TESTS_IN_D := \
	src/test/compile-fail \
	src/test/rustdoc \
	src/test/pretty

TESTS_IN_E := \
	src/test/ui 

TESTS_IN_F := \
	src/test/run-fail \
	src/liballoc \
	src/libcore

TESTS_IN_G := \
	src/tools/rustdoc \
	src/test/rustdoc-js-std \
	src/test/run-make-fulldeps \
	src/libstd

TESTS_IN_H := \
	src/librustc_driver

ci-resume-subset-A:
	$(Q)$(BOOTSTRAP) test \
		$(KEEP_STAGE) \
		$(TESTS_IN_B:%=--exclude %) \
		$(TESTS_IN_C:%=--exclude %) \
		$(TESTS_IN_D:%=--exclude %) \
		$(TESTS_IN_E:%=--exclude %) \
		$(TESTS_IN_F:%=--exclude %) \
		$(TESTS_IN_G:%=--exclude %) \
		$(TESTS_IN_H:%=--exclude %) \
		$(MIN_TEST:%=--exclude %) 
ci-resume-subset-B:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_B)
ci-resume-subset-C:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_C)
ci-resume-subset-D:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_D)
ci-resume-subset-E:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_E)
ci-resume-subset-F:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_F)
ci-resume-subset-G:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_G)
ci-resume-subset-H:
	$(Q)$(BOOTSTRAP) test $(KEEP_STAGE) $(TESTS_IN_H)

.PHONY: dist
